module OodSupport
  # A helper object that describes an access control list (ACL) with entries
  class ACL
    # The entries of this ACL
    # @return [Array<ACLEntry>] list of entries
    attr_reader :entries

    # Whether this ACL defaults to allow, otherwise default deny
    # @return [Boolean] whether default allow
    attr_reader :default

    # Generate an ACL by parsing a string along with options
    # @param acl [#to_s] string describing acl
    # @param kwargs [Hash] extra arguments defining acl
    # @return [ACL] acl generated by string and options
    def self.parse(acl, **kwargs)
      entries = []
      acl.to_s.strip.split(/\n|,/).grep(/^[^#]/).each do |entry|
        entries << entry_class.parse(entry)
      end
      new(entries: entries, **kwargs)
    end

    # @param entries [Array<ACLEntry>] list of entries
    # @param default [Boolean] default allow, otherwise deny
    def initialize(entries:, default: false)
      @entries = entries
      @default = default
    end

    # Check if queried principle has access to resource
    # @param principle [String] principle to check against
    # @return [Boolean] does principle have access?
    def allow?(principle:)
      # Check in array order
      ordered_check(principle: principle)
    end

    # Convert object to string
    # @return [String] the string describing this object
    def to_s
      entries.join("\n")
    end

    # Convert object to hash
    # @return [Hash] the hash describing this object
    def to_h
      { entries: entries, default: default }
    end

    # The comparison operator
    # @param other [#to_h] entry to compare against
    # @return [Boolean] how acls compare
    def ==(other)
      to_h == other.to_h
    end

    # Checks whether two ACL objects are completely identical to each other
    # @param other [ACL] entry to compare against
    # @return [Boolean] whether same objects
    def eql?(other)
      self.class == other.class && self == other
    end

    # Generates a hash value for this object
    # @return [Integer] hash value of object
    def hash
      [self.class, to_h].hash
    end

    private
      # Class used to generate an entry
      def self.entry_class
        ACLEntry
      end

      # Check each entry in order from array
      def ordered_check(**kwargs)
        entries.each do |entry|
          if entry.match(**kwargs)
            # Check if its an allow or deny acl entry (may not be both)
            return true  if entry.is_allow?
            return false if entry.is_deny?
          end
        end
        return default # default allow or default deny
      end
  end
end
